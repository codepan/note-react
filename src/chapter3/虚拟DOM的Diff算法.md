# 什么是虚拟DOM的Diff算法

其实很简单，如何实现新老虚拟DOM的比对？这种比对方式就称之为虚拟DOM的Diff算法

Diff（diffrence的简称）
# 虚拟DOM的比对时机

当数据（state、props）发生变化时，虚拟DOM就会采用Diff算法来进行比对

其实props的变化，归根结底，还是因为父组件的state发生了变化，才会导致子组件的props发生变化。所以比对时机其实就只有一点：

state发生了变化，而state发生变化，又是因为我们调用了setState方法

归纳总结一下：
> 当调用setState方法时，会触发新老虚拟DOM的比对

# setState为什么建议传入函数，来进行异步调用呢？

这是为了提高性能，假设现在我们连续调用多次setState，就会不断的创建新的虚拟DOM，然后进行新老虚拟DOM的比对，然后多次生成真实的DOM，最后多次修改DOM。React为了解决这个问题，提出了异步调用的概念，我们快速的连续调用setState，React并不会立即去做上面一系列的事情，而是会将每次的setState缓存起来，之后合并成一个setState，这样只需要做一次上面的工作，从而省去多次虚拟DOM的生成、比对，真实DOM的生成和修改，从而提高性能。

# Diff算法的一些特性

**同级比较/同层比对**

每次比对都是先比较同层虚拟DOM之间的差异
* 比较第一层，假设第一层相同
* 然后再比较第二层，假设第二层也相同
* 然后依次比较下去
* 假设第一层就不相同，那么就不会再继续向下比对了，而是直接将第一层下面的原始的真实DOm全部从页面中国删除掉，然后根据新的虚拟DOM重新生成真实的DOM，最后用重新生成的真实DOM替换原始页面上的DOM。这样只比对一层，一旦不相同，就停止比对


为什么Diff算法要这样设计？如果第一层不相同，但是第二层、第三层...都相同，完全没必要全部替换呀，而Diff算法却统统的将其干掉，全盘替换掉，势必就造成了性能的没必要的损耗。其实Diff算法这样设计的原因在于以下几点：

* 算法简单，只需要同层比较，一旦不同，停止比较，直接替换DOM
* 算法简单，带来的好处就是比对的速度非常快，虽然会造成相同DOM上的没必要的性能损耗，但是它大大的减少了两个虚拟DOM之间Diff算法比较的时间

**DOM ID（key值）比对**

循环渲染某个DOM时，我们需要给DOM指定一个key值，其目的就在于当DOM结构发生变化时，Diff算法可以快速的找出新老虚拟DOm之间的差异，从而提高性能

在给DOM指定key值，一定要使用稳定的值作为key，使用数组的下标作为key是及其不正确的，所以在开发中，能不用index做key值，就不要用index


